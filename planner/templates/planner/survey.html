{% extends "planner/base.html" %}
{% block title %}Trip Survey{% endblock %}

{% block content %}
<div class="container-lg d-flex flex-column" style="min-height: calc(100vh - 120px); padding-top: 1.5rem; padding-bottom: 1.5rem;">
    <form method="post" id="survey-form" novalidate class="flex-grow-1 d-flex flex-column">
        {% csrf_token %}
        <div class="card chigo-card overflow-hidden border-0 shadow flex-grow-1 d-flex flex-column">

            <!-- Card Header -->
            <div class="px-4 py-4" style="background: linear-gradient(135deg, #0a4bb5 0%, #0d6efd 100%);">
                <h4 class="text-white fw-bold mb-0"><i class="bi bi-map me-2"></i>Plan Your Trip</h4>
                <p class="text-white opacity-75 small mb-0">Tell us about your ideal Chicago adventure</p>
            </div>

            <div class="px-4 py-4 flex-grow-1 d-flex flex-column">

                <!-- Section: Trip Basics -->
                <p class="text-uppercase text-muted small fw-semibold mb-2" style="letter-spacing:.08em;"><i class="bi bi-suitcase me-1"></i>Trip Basics</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold mb-1">Trip Title</label>
                        <input type="text" class="form-control" name="trip_title" placeholder="My Chicago Adventure" required value="{{ form.trip_title.value|default:'' }}">
                        {% if form.trip_title.errors %}<div class="text-danger small">{{ form.trip_title.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold mb-1">Days</label>
                        <input type="number" class="form-control" name="stay_length" min="1" placeholder="3" value="{{ form.stay_length.value|default:'' }}">
                        {% if form.stay_length.errors %}<div class="text-danger small">{{ form.stay_length.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Staying In</label>
                        <select class="form-select" name="stay_location">
                            {% for choice in form.stay_location.field.choices %}
                            <option value="{{ choice.0 }}" {% if form.stay_location.value == choice.0|stringformat:"s" %}selected{% endif %}>{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        {% if form.stay_location.errors %}<div class="text-danger small">{{ form.stay_location.errors.0 }}</div>{% endif %}
                    </div>
                </div>

                <hr class="my-3">

                <!-- Section: Preferences -->
                <p class="text-uppercase text-muted small fw-semibold mb-2" style="letter-spacing:.08em;"><i class="bi bi-heart me-1"></i>Preferences</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Cuisine</label>
                        <select class="form-select" name="preferred_cuisine">
                            {% for choice in form.preferred_cuisine.field.choices %}
                            <option value="{{ choice.0 }}" {% if form.preferred_cuisine.value == choice.0|stringformat:"s" %}selected{% endif %}>{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        {% if form.preferred_cuisine.errors %}<div class="text-danger small">{{ form.preferred_cuisine.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Activity Level</label>
                        <select class="form-select" name="activity_level">
                            {% for choice in form.activity_level.field.choices %}
                            <option value="{{ choice.0 }}" {% if form.activity_level.value == choice.0|stringformat:"s" %}selected{% endif %}>{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        {% if form.activity_level.errors %}<div class="text-danger small">{{ form.activity_level.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Travelling With</label>
                        <select class="form-select" name="social_context">
                            {% for choice in form.social_context.field.choices %}
                            <option value="{{ choice.0 }}" {% if form.social_context.value == choice.0|stringformat:"s" %}selected{% endif %}>{{ choice.1 }}</option>
                            {% endfor %}
                        </select>
                        {% if form.social_context.errors %}<div class="text-danger small">{{ form.social_context.errors.0 }}</div>{% endif %}
                    </div>
                </div>

                <hr class="my-3">

                <!-- Section: Logistics -->
                <p class="text-uppercase text-muted small fw-semibold mb-2" style="letter-spacing:.08em;"><i class="bi bi-sliders me-1"></i>Logistics</p>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Daily Activity Time</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="activity_duration_hours" min="1" placeholder="4" value="{{ form.activity_duration_hours.value|default:'' }}">
                            <span class="input-group-text">hrs</span>
                        </div>
                        {% if form.activity_duration_hours.errors %}<div class="text-danger small">{{ form.activity_duration_hours.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Trip Budget</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" name="budget" min="0" step="0.01" placeholder="500.00" value="{{ form.budget.value|default:'' }}">
                        </div>
                        {% if form.budget.errors %}<div class="text-danger small">{{ form.budget.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold mb-1">Search Radius</label>
                        <div class="input-group">
                            <input type="number" class="form-control" name="radius" min="1" placeholder="5" value="{{ form.radius.value|default:'' }}">
                            <span class="input-group-text">mi</span>
                        </div>
                        {% if form.radius.errors %}<div class="text-danger small">{{ form.radius.errors.0 }}</div>{% endif %}
                    </div>
                </div>

                <div class="flex-grow-1 d-flex flex-column mb-3">
                    <label class="form-label fw-semibold mb-1">
                        <i class="bi bi-slash-circle me-1 text-muted"></i>Anything to avoid? <span class="text-muted fw-normal">(optional)</span>
                    </label>
                    <textarea class="form-control flex-grow-1" name="dislikes" placeholder="e.g., long walks, spicy food, crowded places" style="min-height: 80px;">{{ form.dislikes.value|default:'' }}</textarea>
                    {% if form.dislikes.errors %}<div class="text-danger small">{{ form.dislikes.errors.0 }}</div>{% endif %}
                </div>

                <!-- Submit -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary fw-semibold py-2">
                        <i class="bi bi-stars me-2"></i>Generate My Itinerary
                    </button>
                </div>

            </div>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loading-screen" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(255,255,255,0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; font-size: 2.5rem;">
    <div class="emoji-bounce" id="emoji-click-area">üåÜ <span id="middle-emoji">üçΩÔ∏è</span> ‚è≥</div>
    <div id="loading-text" style="font-size: 1.25rem; margin-top: 1rem;">Planning your perfect trip...</div>
</div>

<style>
    .emoji-bounce {
        display: flex;
        gap: 1.5rem;
        animation: bounce 1.2s infinite;
        user-select: none;
    }

    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const cuisineEmojiMap = {
            "Mexican": "üåÆ", "Japanese": "üç£", "Italian": "üçù",
            "Indian": "üçõ", "Chinese": "ü•°", "American": "üçî",
            "Thai": "ü•¢", "French": "ü•ê", "Mediterranean": "ü•ô",
            "Korean": "üç≤", "Greek": "ü•ó"
        };
        const activityEmojiMap = { "Low": "üßò", "Moderate": "üö∂", "High": "üèÉ" };
        const socialEmojiMap = {
            "Solo": "üßç", "Family": "üë®‚Äçüë©‚Äçüëß‚Äçüë¶", "Friends": "üßë‚Äçü§ù‚Äçüßë", "Work": "üë•"
        };

        const form = document.getElementById("survey-form");
        const loadingScreen = document.getElementById("loading-screen");
        const middleEmoji = document.getElementById("middle-emoji");
        const loadingText = document.getElementById("loading-text");

        // Block e/E/+/- in number inputs (browsers allow them for scientific notation)
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('keydown', function(e) {
                if (['e', 'E', '+', '-'].includes(e.key)) e.preventDefault();
            });
        });

        // Validation helpers
        function setError(el, msg) {
            el.classList.add("is-invalid");
            let fb = el.parentElement.querySelector(".invalid-feedback");
            if (!fb) {
                fb = document.createElement("div");
                fb.className = "invalid-feedback";
                el.parentElement.appendChild(fb);
            }
            fb.textContent = msg;
        }

        function clearError(el) {
            el.classList.remove("is-invalid");
            const fb = el.parentElement.querySelector(".invalid-feedback");
            if (fb) fb.textContent = "";
        }

        function validateForm() {
            let valid = true;
            let firstInvalid = null;

            const required = [
                { el: document.querySelector('[name="trip_title"]'),             msg: "Please enter a trip title." },
                { el: document.querySelector('[name="stay_length"]'),             msg: "Please enter the number of days (at least 1).", min: 1 },
                { el: document.querySelector('[name="stay_location"]'),           msg: "Please select a neighborhood." },
                { el: document.querySelector('[name="preferred_cuisine"]'),       msg: "Please select a cuisine." },
                { el: document.querySelector('[name="activity_level"]'),          msg: "Please select an activity level." },
                { el: document.querySelector('[name="social_context"]'),          msg: "Please select who you're travelling with." },
                { el: document.querySelector('[name="activity_duration_hours"]'), msg: "Please enter daily activity hours (at least 1).", min: 1 },
                { el: document.querySelector('[name="budget"]'),                  msg: "Please enter a budget.", min: 0 },
                { el: document.querySelector('[name="radius"]'),                  msg: "Please enter a search radius (at least 1).", min: 1 },
            ];

            required.forEach(({ el, msg, min }) => {
                if (!el) return;
                clearError(el);
                const val = el.value.trim();
                let invalid = false;

                if (!val) {
                    invalid = true;
                } else if (min !== undefined && parseFloat(val) < min) {
                    invalid = true;
                }

                if (invalid) {
                    setError(el, msg);
                    valid = false;
                    if (!firstInvalid) firstInvalid = el;
                }
            });

            if (firstInvalid) {
                firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
                firstInvalid.focus();
            }

            // Attach live clear-on-change after first validation run
            if (!form._liveValidationAttached) {
                form._liveValidationAttached = true;
                required.forEach(({ el }) => {
                    if (!el) return;
                    el.addEventListener(el.tagName === "SELECT" ? "change" : "input", () => clearError(el));
                });
            }

            return valid;
        }

        form.addEventListener("submit", function (e) {
            e.preventDefault();

            if (!validateForm()) return;

            // Pull values
            const cuisine = document.querySelector('[name="{{ form.preferred_cuisine.name }}"]')?.selectedOptions[0]?.text.trim();
            const activity = document.querySelector('[name="{{ form.activity_level.name }}"]')?.selectedOptions[0]?.text.trim();
            const social = document.querySelector('[name="{{ form.social_context.name }}"]')?.selectedOptions[0]?.text.trim();
            const budget = document.querySelector('[name="{{ form.budget.name }}"]')?.value;

            // Create emoji loop
            const emojiList = [
                cuisineEmojiMap[cuisine] || "üçΩÔ∏è",
                activityEmojiMap[activity] || "üéØ",
                socialEmojiMap[social] || "üßë‚Äçü§ù‚Äçüßë",
                (budget && parseInt(budget) < 1000) ? "üí∏" : "üí∞"
            ];

            middleEmoji.textContent = emojiList[0];
            loadingScreen.style.display = "flex";

            let index = 1;
            const emojiInterval = setInterval(() => {
                middleEmoji.textContent = emojiList[index % emojiList.length];
                index++;
            }, 3000);

            setTimeout(() => {
                loadingText.textContent = "Still working... high-quality plans take time üß†‚ú®";
            }, 10000);

            // Delay submit slightly to keep user engaged
            setTimeout(() => {
                clearInterval(emojiInterval);
                form.submit();
            }, 40000); // adjust this to match backend generation time
        });
    });
</script>
{% endblock %}
