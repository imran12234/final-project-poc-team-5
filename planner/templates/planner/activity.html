{% extends "planner/base.html" %}
{% block title %}Activity Builder{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="border rounded p-3 h-100">
        <h5 class="mb-3">Map View</h5>
        <div id="map" class="w-100" style="height: 700px;"></div>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        {{ activities|json_script:"itineraryCoords" }}
        <script>
          const map = L.map('map').setView([41.8781, -87.6298], 13);
        
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);
        
          const itineraryActivities = JSON.parse( // gets the activities from the script tag right above <script>
            document.getElementById('itineraryCoords').textContent
          );
        
          const coords = [];
        
          itineraryActivities.forEach(activity => {
            const lat = parseFloat(activity.latitude);
            const lng = parseFloat(activity.longitude);
            coords.push([lat, lng]);
        
            L.marker([lat, lng]) // markers for each location on the map
              .addTo(map)
              .bindPopup(`<strong>${activity.place}</strong><br>${activity.description}`); // gives the markers a name and description
          });
        
          if (coords.length >= 2) { // line that connects the different coordinates
            L.polyline(coords, {
              color: 'blue',
              weight: 4,
              opacity: 0.7
            }).addTo(map);
          }
        
          if (coords.length > 0) { // scales the map to fit the coordinates
            map.fitBounds(coords);
          }
        </script>
      </div>
    </div>

    <div class="col-lg-6">
      <h3 class="fw-bold mb-4">Your Itinerary</h3>
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-0">Pick Today’s Adventures</h5>
        <a href="/summary" class="btn btn-primary">Finalize Itinerary</a>
      </div>
      <h5 class="text-center mt-3">Day {{ day }} of {{ total_days }}</h5>

      <hr class="my-5">
      
      <div class="d-flex justify-content-between align-items-center mt-3 mb-3">
        {% if day > 1 %}
          <a href="?day={{ day|add:"-1" }}" class="btn btn-outline-secondary">
            ← Previous Day
          </a>
        {% else %}
          <span></span>
        {% endif %}
      
        {% if day < total_days %}
          <a href="?day={{ day|add:"1" }}" class="btn btn-primary">
            Next Day →
          </a>
        {% endif %}
      </div>

      <form method="post" id="activity-form">
        {% csrf_token %}
        <div class="scrollable-card-list">
          <div class="d-flex flex-column gap-4">
            {% for act in activities %}
            <button type="button"
              class="card activity-card shadow p-0 border-0 position-relative bg-white overflow-hidden"
              data-bs-toggle="modal"
              data-bs-target="#swapModal"
              data-activity-id="{{ act.id }}"
              style="all: unset; display: block; cursor: pointer;">

              <div class="d-flex p-2">
                <img src="{{ act.photo_name }}"
                    class="rounded me-3"
                    style="width: 200px; height: 150px; object-fit: cover;"
                    alt="Activity image">

                <div class="d-flex flex-column flex-grow-1">
                  <h5 class="mb-1">{{ act.place }}</h5>
                  <p class="small text-muted mb-1">{{ act.description }}</p>
                  <p class="small text-muted mb-0">Neighborhood: {{ act.neighborhood }}</p>
                </div>
              </div>

              <div class="swap-overlay d-flex justify-content-center align-items-center">
                <span class="fw-bold fs-3 text-white">Swap out</span>
              </div>
            </button>

            {% endfor %}
          </div>
        </div>
      </form>      
    </div>
  </div>
</div>

<div class="modal fade" id="swapModal" tabindex="-1" aria-labelledby="swapModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="swapModalLabel">Choose a Replacement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="list-group">
          {% for rec in recommendations %}
            <button type="button"
                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-start swap-option"
                    data-replacement-name="{{ rec.name }}"
                    data-replacement-neighborhood="{{ rec.neighborhood }}"
                    data-replacement-description="{{ rec.explanation }}"
                    data-replacement-latitude="{{ rec.latitude }}"
                    data-replacement-longitude="{{ rec.longitude }}"
                    data-replacement-category="{{ rec.category }}"
                    data-replacement-photo_name="{{ rec.photo_name }}"
                    data-replacement-address="{{ rec.address }}">
              <div class="ms-2 me-auto">
                <div class="fw-bold">{{ rec.name }}</div>
                {{ rec.explanation }}
                <div class="text-muted small">Neighborhood: {{ rec.neighborhood }} | Category: {{ rec.category }}</div>
              </div>
            </button>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<form method="post" id="swap-form" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="original_activity_id" id="original-activity-id">
  <input type="hidden" name="replacement_name" id="replacement-name">
  <input type="hidden" name="replacement_neighborhood" id="replacement-neighborhood">
  <input type="hidden" name="replacement_description" id="replacement-description">
  <input type="hidden" name="replacement_latitude" id="replacement-latitude">
  <input type="hidden" name="replacement_longitude" id="replacement-longitude">
  <input type="hidden" name="replacement_category" id="replacement-category">
  <input type="hidden" name="replacement_photo_name" id="replacement-photo_name">
  <input type="hidden" name="replacement_address" id="replacement_address">
</form>

<script>
  let selectedActivityId = null;

  document.querySelectorAll('.activity-card').forEach(card => {
    card.addEventListener('click', function () {
      selectedActivityId = this.getAttribute('data-activity-id');
      console.log("Selected activity ID set to:", selectedActivityId);

      document.getElementById('original-activity-id').value = selectedActivityId;
    });
  });

  document.querySelectorAll('.swap-option').forEach(option => {
    option.addEventListener('click', function () {
      if (!selectedActivityId) {
        alert("No activity selected to swap!");
        return;
      }

      document.getElementById('replacement-name').value = this.getAttribute('data-replacement-name');
      document.getElementById('replacement-neighborhood').value = this.getAttribute('data-replacement-neighborhood');
      document.getElementById('replacement-description').value = this.getAttribute('data-replacement-description');
      document.getElementById('replacement-latitude').value = this.getAttribute('data-replacement-latitude');
      document.getElementById('replacement-longitude').value = this.getAttribute('data-replacement-longitude');
      document.getElementById('replacement-category').value = this.getAttribute('data-replacement-category');
      document.getElementById('replacement-photo_name').value = this.getAttribute('data-replacement-photo_name');
      document.getElementById('replacement_address').value = this.getAttribute('data-replacement-address');
      

      document.getElementById('swap-form').submit();
    });
  });

</script>

<style>
  .activity-card {
    border: 1px solid transparent;
    transition: background-color 0.2s ease;
  }

  .activity-card .swap-overlay {
    position: absolute;
    inset: 0;
    background-color: rgba(108, 117, 125, 0.5);
    opacity: 0;
    transition: opacity 0.2s ease;
    pointer-events: none; /* so clicks still go to the button */
  }

  .activity-card:hover .swap-overlay {
    opacity: 1;
  }

  .btn {
  min-width: 120px;
  }

  .scrollable-card-list {
    max-height: 500px;
    overflow-y: auto;
    padding-right: 8px;
    margin-top: 1rem;
  }

  #map {
      height: 600px;
      width: 100%;
  }

</style>



{% endblock %}
